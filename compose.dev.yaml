# DOCKER DEV FILE
# docker compose -f compose.dev.yaml -p matli-dev watch
# docker compose -f compose.dev.yaml -p matli-dev build --no-cache

networks:
  matli_network:
    name: matli_network

services:
  web-server:
    build:
      context: ./web-server
      dockerfile: ./docker/Dockerfile.dev
    ports:
      - 4000:4000
    env_file:
      - ./secrets/calc-db/.db.env
    develop:
      watch:
        - action: sync
          path: ./web-server/src
          target: /usr/web-server/src
          ignore:
            - node_modules/
            - dist/
        - action: rebuild
          path: ./web-server/package.json
        - action: rebuild
          path: ./web-server/tsconfig.json
        - action: rebuild
          path: ./web-server/nest-cli.json
        - action: rebuild
          path: ./web-server/docker

    depends_on:
      - db

  ionic-client:
    build:
      context: ./ionic-client
      dockerfile: ./docker/Dockerfile.dev
    ports:
      - 5173:5173
    develop:
      watch:
        - action: sync
          path: ./ionic-client
          target: /usr/app
          ignore:
            - node_modules/
    depends_on:
      - db

  nginx:
    build: ./nginx
    ports:
      - "80:80"
    depends_on:
      - ionic-client
      - web-server
      - db

  # db:
  #   image: postgres
  #   restart: always
  #   user: postgres
  #   volumes:
  #     - ./secrets/calc-db/db-password.txt:/run/secrets/db-password
  #   environment:
  #     - POSTGRES_PASSWORD_FILE=/run/secrets/db-password
  #     - POSTGRES_DB=calc

  db:
    image: postgres
    restart: always
    user: postgres
    environment:
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
      - POSTGRES_DB=calc

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
    depends_on:
      - db
